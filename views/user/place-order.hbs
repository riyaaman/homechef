<!-- Page Title
============================================= -->
<section id="page-title">
	<div class="container clearfix">
		<h1>Checkout</h1>
		<ol class="breadcrumb">
			<li class="breadcrumb-item"><a href="/">Home</a></li>
			<li class="breadcrumb-item"><a href="/cart">Cart</a></li>
			<li class="breadcrumb-item active" aria-current="page">Checkout</li>
		</ol>
	</div>

</section><!-- #page-title end -->

<!-- Content
============================================= -->
<section id="content">
	<div class="content-wrap ">
		<div class="container clearfix ">
			<div class="row col-mb-50 gutter-50">
				<form id="checkout-form" name="checkout-form" class="row mb-0" action="#" method="post">
					<div class="col-lg-6 ">
						<h3>Billing Address</h3>
						<p>Lorem ipsum dolor sit amet, consectetur adipisicing elit. Unde, vel odio non dicta provident
							sint
							ex autem mollitia dolorem illum repellat ipsum aliquid illo similique sapiente fugiat minus
							ratione.</p>
						<input type="text" name="userId" value="{{user._id}}" hidden>
						<div class="w-100"></div>
						{{#if user_address}}
						{{#each user_address}}
						<div class="col-12 form-group">
							<label for="billing-address">Address:</label>
							<input type="text" id="billing-address" name="billing_address" value="{{this.address}}"
								class="sm-form-control" required />
						</div>
						<div class="col-12 form-group">
							<label for="billing-city">City / Town</label>
							<input type="text" id="billing-city" name="billing_city" value="{{this.city}}"
								class="sm-form-control" required />
						</div>
						<div class="col-12 form-group">
							<label for="billing-pincode">Pincode:</label>
							<input type="text" id="billing-pincode" name="billing_pincode" value="{{this.postcode}}"
								class="sm-form-control" required />
						</div>
						<div class="col-12 form-group">
							<label for="billing-state">State </label>
							<input type="text" id="billing-state" name="billing_state" value="{{this.state}}"
								class="sm-form-control" required />
						</div>
						{{/each}}
						{{else}}
						<div class="col-12 form-group">
							<label for="billing-address">Address:</label>
							<input type="text" id="billing-address" name="billing_address" value="{{this.address}}"
								class="sm-form-control" required />
						</div>
						<div class="col-12 form-group">
							<label for="billing-city">City / Town</label>
							<input type="text" id="billing-city" name="billing_city" value="{{this.city}}"
								class="sm-form-control" required />
						</div>
						<div class="col-12 form-group">
							<label for="billing-pincode">Pincode:</label>
							<input type="text" id="billing-pincode" name="billing_pincode" value="{{this.postcode}}"
								class="sm-form-control" required />
						</div>
						<div class="col-12 form-group">
							<label for="billing-state">State </label>
							<input type="text" id="billing-state" name="billing_state" value="{{this.state}}"
								class="sm-form-control" required />
						</div>
						{{/if}}
					</div>
					<div class="col-md-5">
						<div class="card">
							<div class="card-body">
								<div class="style-msg errormsg" id="coupon_error" style="display: none;">
									<div class="sb-msg">
										<i class="icon-remove"></i>
										This coupon code is invalid or has expired.
									</div>
								</div>
								Have a coupon? <a> Enter Your Code Here</a><br>
								<input type="text" name="coupon_code" id="coupon_code" class="mt-1 p-1">
								<div id="btnCoupon" name="btnCoupon" class="btn bg-color">Apply Code</div>
							</div>
						</div>
						<div class="col-lg-12 mt-5">
							<h4>Cart Totals</h4>
							<div class="table-responsive">
								<table class="table cart">
									<tbody>
										{{#each total}}
										<tr class="cart_item">
											<td class="border-top-0 cart-product-name">
												<strong>Cart Subtotal</strong>
											</td>

											<td class="border-top-0 cart-product-name">
												<span class="amount">{{this.total_org}}.00</span>
												<input type="hidden" id="total_amount" name="total_amount"
													value="{{this.total_org}}"> </td>
										</tr>
										<tr class="cart_item">
											<td class="cart-product-name">
												<strong>Shipping</strong>
											</td>

											<td class="cart-product-name">
												<span class="amount">Free Delivery</span>
											</td>
										</tr>
										<tr class="cart_item">
											<td class="cart-product-name">
												<strong>Coupon</strong>
											</td>

											<td class="cart-product-name">
												<span class="amount" id="coupon_amount" name="coupon_amount">0.00</span>
												 {{!-- <input type="hidden" name="coupon_percent" id="coupon_percent" value="" /> --}}
												  <input type="hidden" name="coupon_id" id="coupon_id" value="" />
											</td>
										</tr>
										<tr class="cart_item">
											<td class="cart-product-name">
												<strong>Discount</strong>
											</td>

											<td class="cart-product-name">
												<span class="amount" id="discount_amount" name="discount_amount">{{this.discount}}.00</span>
												
											</td>
										</tr>
										<tr class="cart_item">
											<td class="cart-product-name">
												<strong>Total</strong>
											</td>

											<td class="cart-product-name">
												<span id="total" class="amount color lead"><strong>{{this.total}} Rs.</strong></span>
											 <input type="hidden" name="cart_total" id="cart_total" value="{{this.total}}" />
											</td>
										</tr>
										{{/each}}
									</tbody>
								</table>
							</div>
							<div class="col-lg-12">
								<h4>Payment Options</h4>								
								<div class="custom-control custom-radio">
									<input type="radio" class="custom-control-input" id="defaultChecked"
										name="payment-method" checked value="COD">
									<label class="custom-control-label" for="defaultChecked">Cash On Delivery</label>
								</div><br>								
								<div class="custom-control custom-radio">
									<input type="radio" class="custom-control-input" id="defaultUnchecked"
										name="payment-method" value="RAZORPAY">
									<label class="custom-control-label" for="defaultUnchecked">Pay with Razorpay
									</label>
								</div><br>
								<div class="custom-control custom-radio">
									<input type="radio" class="custom-control-input" id="paypal1" name="payment-method"
										value="PAYPAL">
									<label class="custom-control-label " for="paypal1">Pay with PayPal</label>
								</div><br>

								<button type="submit" class="float-left btn bg-color mr-5 mb-2"
									id="checkout">Continue</button>
								<br><br>
								<div id="paypal-button-container" style="width:50px"></div><br>
							</div>
						</div>
					</div>
					<div class="w-100"></div>


					{{!-- paypal  --}}
					{{!-- <input type="hidden" name="cart_id" id="cart_id" value="{{total}}" /> --}}
					<input type="hidden" name="order_id" id="order_id" value="" />		

				</form>
			</div>
		</div>
	</div>

</section><!-- #content end -->

<script>
	$(document).ready(function () {
		$("#paypal-button-container").hide();
		$("#checkout").show();
		$("#btnCoupon").click(function () {			
			let subtotal	=	$("#cart_total").val()
			let coupon_code = 	$("#coupon_code").val()
			$.ajax({
				url: 'apply_coupon_code',
				data: { coupon_code: coupon_code, subtotal: subtotal },
				method: 'post',
				success: (response) => {
					if (response.status == false) {
						$("#coupon_error").show();
						$(".sb-msg").text("This coupon code is invalid or has expired.");
					}
					else if (response.status == "less") {
						minimum_amount = response.minimum_amount
						$("#coupon_error").show();
						$(".sb-msg").text("Minimum Amount Should Be Greater Than  " + minimum_amount);
					}
					else if (response.status == "used") {
						minimum_amount = response.minimum_amount
						$("#coupon_error").show();
						$(".sb-msg").text("This coupon code is Already Purchased.");
					}
					else {					
						total = response.total
						coupon_discount = response.coupon_discount
						$("#coupon_error").hide();
						$("#coupon_amount").text(coupon_discount);
						$("#total").text(total);
						$("#cart_total").val(total);	
						$("#coupon_id").val(response.coupon_id);				
						$("#btnCoupon").hide();
					}

				}
			})
		});

		//form validation
		$("#checkout-form").validate({
			// Specify validation rules
			rules: {
				billing_address: {
					required: true,
				},
				billing_city: {
					required: true,
				},
				billing_pincode: {
					required: true,
					digits: true,
					minlength: 6,
					maxlength: 6
				}
			},
			messages: {
				billing_address: {
					required: "Please Enter your address",
				},
				billing_city: {
					required: "Please Enter Your City",
				},
				billing_pincode: {
					required: "Please Enter pincode",
					digits: "Please Enter a Valid Pincode",
					minlength: "Your Pincode Must be 6 digits",
					maxlength: "Your Pincode Must be 6 digits"
				}

			},

		});

	});

</script>

<script>
	$("#checkout-form").submit((e) => {
		e.preventDefault()
		if ($('#checkout-form').valid() == true) {			
			$.ajax({
				url: '/place-order',
				method: 'post',
				data: $('#checkout-form').serialize(),
				success: (response) => {
					if (response.cod_success) {
						location.href = '/order_success'
					}
					else if (response.cod_success == false) {
						$("#checkout").hide();
						$("#paypal-button-container").show();
						document.getElementById("order_id").value = response.orderId					
					}
					else {
						razorpayPayment(response)
					}
				}
			})			
		}
		return false;
	})
	function razorpayPayment(order) {
		var options = {
			"key": "rzp_test_P1qJn93ykpKDDb", // Enter the Key ID generated from the Dashboard
			"amount": order.amount, // Amount is in currency subunits. Default currency is INR. Hence, 50000 refers to 50000 paise
			"currency": "INR",
			"name": "Crossroads",
			"description": "Test Transaction",
			"image": "https://example.com/your_logo",
			"callback_url": 'https://www.google.com',
			  "modal": {
                        "ondismiss": function() {
							location.href = '/order_paypal_cancel'	
                        }
                    },
			"order_id": order.id, //This is a sample Order ID. Pass the `id` obtained in the response of Step 1
			"handler": function (response) {
				//alert(response.razorpay_payment_id);alert(response.razorpay_order_id);alert(response.razorpay_signature);
				
			},
			"prefill": {
				"name": "Snacky",
				"email": "snackydemo@gmail.com",
				"contact": "9999999999"
			},
			"notes": {
				"address": "Razorpay Corporate Office"
			},
			"theme": {
				"color": "#3399cc"
			}
		};
		var rzp1 = new Razorpay(options);		
		rzp1.open()
		
	}
	function verifyPayment(payment,order) {		
		$.ajax({
			url: 'verify_payment',
			data: {
				payment,
				order
			},
			method: 'post',
			success: (response) => {			
				if (response.status) {
					location.href = '/order_success'
				}
				else {				
					alert("Payment Failed")
					location.href = '/order_paypal_cancel'					
				}
			}
		})
	}

</script> 

<script
	src="https://www.paypal.com/sdk/js?client-id=ARz77seSj_48d8nnhv7Djub47ZZbnIC4LRxCwU_4-e2ZCoscT4cB3CIImB1EfUjAiJHoCPcCIVVw7BEO&disable-funding=credit,card"> // Required. Replace SB_CLIENT_ID with your sandbox client ID.
</script>
<script src="/javascripts/paypal.js"></script>